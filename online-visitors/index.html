<!DOCTYPE html>
<html lang="en">
<head>
	
		<title>GopherBOOk: Online Visitors</title>
	
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<meta name="description" content="This example will show how to do an online visitors system per-page in the Go programming language." />
	<link rel="alternate" type="application/rss+xml" href="/index.xml" />
	<link rel="canonical" href="http://gopherbook.iris-go.com/online-visitors/">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
	<meta name="theme-color" content="#bb8844">
	<style>
		body {
			margin: 0;
			font-family: -apple-system, "San Francisco", "Helvetica Neue", "Noto",  "Roboto", "Calibri Light", sans-serif;
			color: #212121;
			font-size: 1.1em;
			line-height: 1.6;
		}
		.container { max-width: 700px; margin: auto; padding: 15px; }
		a {	color: black; }
		p { font-family: "Georgia", serif; margin: 0.5em 0; }
		h1 { margin: 1em 0; }
		h1 a { text-decoration: none; }
		h2 { font-size: 1.2em; margin: 0.5em 0; }
		pre { padding: 15px; overflow-x: auto; background: #fafafa; border: 1px solid #f0f0f0; }
		.demo pre { background-color: white; border: none; margin: 1em 0 0 0; padding: 0; }
		a[target="_blank"] { background: url(/link.svg) right top/9px no-repeat; padding-right: 12px; }
		.links { display: flex; justify-content: space-between; }
		a.back { text-decoration: none; }
		a.home { text-decoration: none; }
		a.forward { text-decoration: none; }
		.footer { font-size: .9em; margin-top: 1em; color: #999; font-family: "Georgia", serif; }
		.footer a { color: #999; }
		.image { border: 1px solid #f0f0f0; }
		.image img { max-width: 100%; height: auto; display: block; }
		.demo { border: 1px solid #f0f0f0; padding: 15px; line-height: 1.4; pointer-events: none; }
		.demo h1 { margin: 0 0 0.5em 0; font-size: 1.5em; }
		.demo input[type=text], .demo textarea { box-sizing: border-box; width: 100%; max-width: 20em; }
	</style>
</head>
<body>
<div class="container">



<h1 id="go-web-examples-online-visitors"><a href="/">Go Web Examples:</a> Online Visitors</h1>

<p>This example will show how to do an online visitors system per-page.</p>

<pre><code>// file online-visitors.go
package main

import (
    &quot;sync/atomic&quot;

    &quot;gopkg.in/kataras/iris.v6&quot;
    &quot;gopkg.in/kataras/iris.v6/adaptors/httprouter&quot;
    &quot;gopkg.in/kataras/iris.v6/adaptors/view&quot;
    &quot;gopkg.in/kataras/iris.v6/adaptors/websocket&quot;
)

var (
    app *iris.Framework
    ws  websocket.Server
)

func init() {
    // init the server instance
    app = iris.New()
    // adapt a logger in dev mode
    app.Adapt(iris.DevLogger())
    // adapt router
    app.Adapt(httprouter.New())
    // adapt templaes
    app.Adapt(view.HTML(&quot;./templates&quot;, &quot;.html&quot;).Reload(true))
    // adapt websocket
    ws = websocket.New(websocket.Config{Endpoint: &quot;/my_endpoint&quot;})
    ws.OnConnection(HandleWebsocketConnection)
    app.Adapt(ws)
}

type page struct {
    PageID string
}

func main() {
    app.StaticWeb(&quot;/js&quot;, &quot;./static/assets/js&quot;)

    h := func(ctx *iris.Context) {
        ctx.Render(&quot;index.html&quot;, page{PageID: &quot;index page&quot;})
    }

    h2 := func(ctx *iris.Context) {
        ctx.Render(&quot;other.html&quot;, page{PageID: &quot;other page&quot;})
    }

    // Open some browser tabs/or windows
    // and navigate to
    // http://localhost:8080/ and http://localhost:8080/other
    // Each page has its own online-visitors counter.
    app.Get(&quot;/&quot;, h)
    app.Get(&quot;/other&quot;, h2)
    app.Listen(&quot;:8080&quot;)
}

type pageView struct {
    source string
    count  uint64
}

func (v *pageView) increment() {
    atomic.AddUint64(&amp;v.count, 1)
}

func (v *pageView) decrement() {
    oldCount := v.count
    if oldCount &gt; 0 {
        atomic.StoreUint64(&amp;v.count, oldCount-1)
    }
}

func (v *pageView) getCount() uint64 {
    val := atomic.LoadUint64(&amp;v.count)
    return val
}

type (
    pageViews []pageView
)

func (v *pageViews) Add(source string) {
    args := *v
    n := len(args)
    for i := 0; i &lt; n; i++ {
        kv := &amp;args[i]
        if kv.source == source {
            kv.increment()
            return
        }
    }

    c := cap(args)
    if c &gt; n {
        args = args[:n+1]
        kv := &amp;args[n]
        kv.source = source
        kv.count = 1
        *v = args
        return
    }

    kv := pageView{}
    kv.source = source
    kv.count = 1
    *v = append(args, kv)
}

func (v *pageViews) Get(source string) *pageView {
    args := *v
    n := len(args)
    for i := 0; i &lt; n; i++ {
        kv := &amp;args[i]
        if kv.source == source {
            return kv
        }
    }
    return nil
}

func (v *pageViews) Reset() {
    *v = (*v)[:0]
}

var v pageViews

// HandleWebsocketConnection handles the online viewers per example(gist source)
func HandleWebsocketConnection(c websocket.Connection) {

    c.On(&quot;watch&quot;, func(pageSource string) {
        v.Add(pageSource)
        // join the socket to a room linked with the page source
        c.Join(pageSource)

        viewsCount := v.Get(pageSource).getCount()
        if viewsCount == 0 {
            viewsCount++ // count should be always &gt; 0 here
        }
        c.To(pageSource).Emit(&quot;watch&quot;, viewsCount)
    })

    c.OnLeave(func(roomName string) {
        if roomName != c.ID() { // if the roomName  it's not the connection iself
            // the roomName here is the source, this is the only room(except the connection's ID room) which we join the users to.
            pageV := v.Get(roomName)
            if pageV == nil {
                return // for any case that this room is not a pageView source
            }
            // decrement -1 the specific counter for this page source.
            pageV.decrement()
            // 1. open 30 tabs.
            // 2. close the browser.
            // 3. re-open the browser
            // 4. should be  v.getCount() = 1
            // in order to achieve the previous flow we should decrement exactly when the user disconnects
            // but emit the result a little after, on a goroutine
            // getting all connections within this room and emit the online views one by one.
            // note:
            // we can also add a time.Sleep(2-3 seconds) inside the goroutine at the future if we don't need 'real-time' updates.
            go func(currentConnID string) {
                for _, conn := range ws.GetConnectionsByRoom(roomName) {
                    if conn.ID() != currentConnID {
                        conn.Emit(&quot;watch&quot;, pageV.getCount())
                    }

                }
            }(c.ID())
        }

    })
}
</code></pre>

<pre><code>// file static/assets/js/visitors.js
(function() {
  var socket = new Ws(&quot;ws://localhost:8080/my_endpoint&quot;);

  socket.OnConnect(function () {
      socket.Emit(&quot;watch&quot;, PAGE_SOURCE);
  });


  socket.On(&quot;watch&quot;, function (onlineViews) {
      var text = &quot;1 online view&quot;;
      if (onlineViews &gt; 1) {
          text = onlineViews + &quot; online views&quot;;
      }
      document.getElementById(&quot;online_views&quot;).innerHTML = text;
  });

  socket.OnDisconnect(function () {
    document.getElementById(&quot;online_views&quot;).innerHTML = &quot;you've been disconnected&quot;;
  });

})();
</code></pre>

<pre><code>&lt;!-- file ./templates/index.html --&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;title&gt;Online visitors example&lt;/title&gt;
    &lt;style&gt;
        body {
            margin: 0;
            font-family: -apple-system, &quot;San Francisco&quot;, &quot;Helvetica Neue&quot;, &quot;Noto&quot;, &quot;Roboto&quot;, &quot;Calibri Light&quot;, sans-serif;
            color: #212121;
            font-size: 1.0em;
            line-height: 1.6;
        }

        .container {
            max-width: 750px;
            margin: auto;
            padding: 15px;
        }

        #online_views {
            font-weight: bold;
            font-size: 18px;
        }
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;span id=&quot;online_views&quot;&gt;1 online view&lt;/span&gt;
    &lt;/div&gt;

    &lt;script type=&quot;text/javascript&quot;&gt;
      /* take the page source from our passed struct  on .Render */
      var PAGE_SOURCE = {{ .PageID }}
    &lt;/script&gt;

    &lt;script src=&quot;/iris-ws.js&quot;&gt;&lt;/script&gt;

    &lt;script src=&quot;/js/visitors.js&quot;&gt;&lt;/script&gt;

&lt;/body&gt;

&lt;/html&gt;

</code></pre>

<pre><code>&lt;!-- file ./templates/other.html --&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;title&gt;Different page, different results&lt;/title&gt;
    &lt;style&gt;
        #online_views {
            font-weight: bold;
            font-size: 18px;
        }
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;

    &lt;span id=&quot;online_views&quot;&gt;1 online view&lt;/span&gt;


    &lt;script type=&quot;text/javascript&quot;&gt;
      /* take the page source from our passed struct  on .Render */
      var PAGE_SOURCE = {{ .PageID }}
    &lt;/script&gt;

    &lt;script src=&quot;/iris-ws.js&quot;&gt;&lt;/script&gt;

    &lt;script src=&quot;/js/visitors.js&quot;&gt;&lt;/script&gt;

&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<pre><code>$ tree ./
online-visitors.go
static/
└── assets/
        └──js/
           └── visitors.js
templates/
└── index.html
└── other.html
</code></pre>

<pre><code>$ go run online-visitors.go
</code></pre>

	<div class="footer">
		<div class="links">
		
			
			<a title="Render Markdown and Cache Handler" class="back" href="http://gopherbook.iris-go.com/cache-markdown/">← back</a>
			
			<a title="GopherBOOk" class="home" href="/">home</a>
			
			<a title="GopherBOOk" class="forward" href="http://gopherbook.iris-go.com/">forward →</a>
			
		
		</div>
		<br /><br />
		 <a href="https://github.com/kataras/iris">Iris web framework</a>
	</div>
</div>
</body>
</html>
